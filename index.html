import React, { useState, useEffect, createContext, useContext } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, signInAnonymously } from 'firebase/auth';
import { getFirestore, collection, query, onSnapshot, Timestamp, addDoc } from 'firebase/firestore';

// 1. Inisialisasi Firebase dan Konteks Otentikasi
// Konfigurasi Firebase Anda yang sudah terintegrasi
const firebaseConfig = {
  apiKey: "AIzaSyDVdSSeAlhK1sgjyeSLSdNW3zesatzPKDE",
  authDomain: "data-absen-2025.firebaseapp.com",
  projectId: "data-absen-2025",
  storageBucket: "data-absen-2025.firebasestorage.app",
  messagingSenderId: "771101147789",
  appId: "1:771101147789:web:955049d4939500cfe4d8c4",
  measurementId: "G-H0S4BS3M50"
};

const appId = "1:771101147789:web:955049d4939500cfe4d8c4"; // Ini adalah appId dari konfigurasi Anda

// Buat konteks untuk otentikasi Firebase
const AuthContext = createContext(null);

// Komponen penyedia otentikasi
function AuthProvider({ children }) {
  const [user, setUser] = useState(null);
  const [loading, setLoading] = useState(true);
  const [db, setDb] = useState(null);
  const [auth, setAuth] = useState(null);

  useEffect(() => {
    // Inisialisasi Firebase hanya sekali saat komponen dimuat
    const app = initializeApp(firebaseConfig);
    const firestoreDb = getFirestore(app);
    const firebaseAuth = getAuth(app);

    setDb(firestoreDb);
    setAuth(firebaseAuth);

    // Otentikasi awal menggunakan token kustom atau anonim
    const authenticate = async () => {
      try {
        // Menggunakan __initial_auth_token jika tersedia, jika tidak, sign in anonim
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(firebaseAuth, __initial_auth_token);
        } else {
          await signInAnonymously(firebaseAuth);
        }
      } catch (error) {
        console.error("Gagal otentikasi awal:", error);
      }
    };

    authenticate();

    // Listener perubahan status otentikasi
    const unsubscribe = onAuthStateChanged(firebaseAuth, (currentUser) => {
      setUser(currentUser);
      setLoading(false);
    });

    // Cleanup listener saat komponen dilepas
    return () => unsubscribe();
  }, []); // Dependensi kosong agar hanya berjalan sekali

  // Menyediakan nilai konteks
  return (
    <AuthContext.Provider value={{ user, loading, db, auth, appId }}>
      {!loading && children}
      {loading && (
        <div className="flex items-center justify-center min-h-screen bg-gray-100">
          <div className="text-gray-700 text-lg font-semibold">Memuat aplikasi...</div>
        </div>
      )}
    </AuthContext.Provider>
  );
}

// Hook kustom untuk menggunakan konteks otentikasi
function useAuth() {
  return useContext(AuthContext);
}

// 2. Komponen Halaman Login Admin
function LoginPage() {
  const { auth } = useAuth();
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [error, setError] = useState('');
  const [loading, setLoading] = useState(false);

  const handleLogin = async () => {
    setError('');
    setLoading(true);
    try {
      if (!auth) {
        throw new Error("Firebase Auth belum diinisialisasi.");
      }
      await signInWithEmailAndPassword(auth, email, password);
    } catch (err) {
      console.error("Kesalahan login:", err.message);
      setError('Gagal login. Periksa email dan kata sandi Anda.');
      // Instruksi untuk demo user
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-500 to-purple-600 p-4">
      <div className="bg-white p-8 rounded-xl shadow-2xl w-full max-w-sm text-center transform transition-all duration-300 hover:scale-105">
        <h2 className="text-3xl font-extrabold text-gray-800 mb-6">Login Admin</h2>
        {error && <p className="text-red-600 mb-4 font-medium">{error}</p>}
        <div className="mb-4">
          <input
            type="email"
            placeholder="Email Admin"
            value={email}
            onChange={(e) => setEmail(e.target.value)}
            className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200"
          />
        </div>
        <div className="mb-6">
          <input
            type="password"
            placeholder="Kata Sandi"
            value={password}
            onChange={(e) => setPassword(e.target.value)}
            className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200"
          />
        </div>
        <button
          onClick={handleLogin}
          disabled={loading}
          className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition-all duration-300 transform hover:-translate-y-1 focus:outline-none focus:ring-4 focus:ring-blue-300 disabled:opacity-50 disabled:cursor-not-allowed"
        >
          {loading ? 'Memuat...' : 'Login'}
        </button>
        <p className="mt-6 text-sm text-gray-500">
          Untuk demo, gunakan: <br/>
          Email: <span className="font-semibold">admin@example.com</span> <br/>
          Pass: <span className="font-semibold">password123</span> <br/>
          (Pastikan user ini sudah dibuat di Firebase Authentication Anda)
        </p>
      </div>
    </div>
  );
}

// 3. Komponen Dashboard Admin
function AdminDashboard() {
  const { user, db, auth, appId } = useAuth();
  const [attendanceRecords, setAttendanceRecords] = useState([]);
  const [loadingAttendance, setLoadingAttendance] = useState(true);
  const [addingRecord, setAddingRecord] = useState(false);

  // Path koleksi untuk data absensi publik
  // Data disimpan di /artifacts/{appId}/public/data/attendanceRecords
  const attendanceCollectionPath = `artifacts/${appId}/public/data/attendanceRecords`;

  useEffect(() => {
    if (!db || !user) {
        console.log("Database atau User belum siap untuk mengambil data absensi.");
        return;
    }

    // Mendapatkan data absensi secara real-time menggunakan onSnapshot
    const q = query(collection(db, attendanceCollectionPath));
    const unsubscribe = onSnapshot(q, (snapshot) => {
      const records = snapshot.docs.map(doc => ({
        id: doc.id,
        ...doc.data()
      }));
      // Mengurutkan absensi berdasarkan timestamp terbaru (descending)
      records.sort((a, b) => b.timestamp.toDate() - a.timestamp.toDate());
      setAttendanceRecords(records);
      setLoadingAttendance(false);
    }, (error) => {
      console.error("Kesalahan mengambil data absensi:", error);
      setLoadingAttendance(false);
    });

    // Cleanup listener saat komponen dilepas untuk mencegah kebocoran memori
    return () => unsubscribe();
  }, [db, user, attendanceCollectionPath]); // Dependensi untuk menjalankan ulang efek jika db/user/path berubah

  const handleLogout = async () => {
    try {
      if (auth) {
        await signOut(auth);
      }
    } catch (error) {
      console.error("Kesalahan logout:", error);
    }
  };

  const handleAddAttendance = async () => {
    if (!db || !user) {
        console.error("Database atau User belum siap untuk menambahkan absensi.");
        return;
    }
    setAddingRecord(true);
    try {
      const now = new Date();
      const newRecord = {
        userId: user.uid, // Menggunakan UID admin sebagai contoh user yang absen
        timestamp: Timestamp.fromDate(now), // Timestamp Firebase
        dateString: now.toLocaleDateString('id-ID', { year: 'numeric', month: 'long', day: 'numeric' }),
        timeString: now.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit', second: '2-digit' }),
        simulatedLocation: "Sore Arabica" // Contoh lokasi
      };
      // Menambahkan dokumen baru ke koleksi absensi
      await addDoc(collection(db, attendanceCollectionPath), newRecord);
      console.log("Absensi baru ditambahkan!");
    } catch (error) {
      console.error("Gagal menambahkan absensi:", error);
    } finally {
      setAddingRecord(false);
    }
  };

  // Tampilkan loading jika data absensi masih dimuat
  if (loadingAttendance) {
    return (
      <div className="flex items-center justify-center min-h-screen bg-gray-100">
        <div className="text-gray-700 text-lg font-semibold">Memuat data absensi...</div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gray-100 p-4 sm:p-6 lg:p-8">
      <div className="max-w-4xl mx-auto bg-white rounded-xl shadow-2xl p-6 sm:p-8">
        <div className="flex justify-between items-center mb-6">
          <h2 className="text-3xl font-extrabold text-gray-800">Dashboard Admin Absensi</h2>
          <button
            onClick={handleLogout}
            className="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-200"
          >
            Logout
          </button>
        </div>

        <div className="mb-6 bg-blue-50 p-4 rounded-lg border border-blue-200">
            <p className="text-blue-700 font-semibold mb-2">
                User ID Aktif (Admin): <span className="font-bold break-all">{user?.uid || 'Tidak Diketahui'}</span>
            </p>
            <button
                onClick={handleAddAttendance}
                disabled={addingRecord}
                className="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-all duration-300 transform hover:-translate-y-0.5 focus:outline-none focus:ring-4 focus:ring-green-300 disabled:opacity-50 disabled:cursor-not-allowed"
            >
                {addingRecord ? 'Menambahkan...' : 'Simulasikan Absensi Baru'}
            </button>
            <p className="text-sm text-gray-500 mt-2">
                (Ini akan menambahkan catatan absensi dengan UID admin sebagai contoh)
            </p>
        </div>


        <h3 className="text-2xl font-bold text-gray-700 mb-4">Catatan Absensi</h3>
        {attendanceRecords.length === 0 ? (
          <p className="text-gray-600 text-lg">Belum ada catatan absensi.</p>
        ) : (
          <div className="overflow-x-auto rounded-lg border border-gray-200 shadow-sm">
            <table className="min-w-full divide-y divide-gray-200">
              <thead className="bg-gray-50">
                <tr>
                  <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Tanggal
                  </th>
                  <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Waktu
                  </th>
                  <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    User ID
                  </th>
                  <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Lokasi
                  </th>
                </tr>
              </thead>
              <tbody className="bg-white divide-y divide-gray-200">
                {attendanceRecords.map((record) => (
                  <tr key={record.id} className="hover:bg-gray-50">
                    <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                      {record.dateString}
                    </td>
                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-700">
                      {record.timeString}
                    </td>
                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-700 break-all">
                      {record.userId}
                    </td>
                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-700">
                      {record.simulatedLocation || '-'}
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        )}
      </div>
    </div>
  );
}

// 4. Komponen Utama Aplikasi (App)
export default function App() {
  return (
    <AuthProvider>
      <AppContent />
    </AuthProvider>
  );
}

function AppContent() {
  const { user, loading } = useAuth();

  if (loading) {
    return null; // Loading state handled by AuthProvider
  }

  // Jika user terautentikasi (sudah login), tampilkan dashboard
  if (user) {
    return <AdminDashboard />;
  }

  // Jika belum terautentikasi, tampilkan halaman login
  return <LoginPage />;
}
